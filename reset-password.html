<!DOCTYPE html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="images/favicon.png" />
  <link rel="stylesheet" href="css/bootstrap-lg.min.css" />
  <link rel="stylesheet" href="css/style-lg.css" />
  <link rel="stylesheet" href="css/fontawesome-all-lg.min.css" />

  <style>
    .video-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
    }
    .error-message {
      color: #ff6b6b;
      font-size: 0.9em;
      margin-top: 5px;
      padding: 10px;
      background-color: rgba(255, 107, 107, 0.1);
      border-radius: 5px;
      border-left: 4px solid #ff6b6b;
    }
    .success-message {
      color: #51cf66;
      font-size: 0.9em;
      margin-top: 5px;
      padding: 10px;
      background-color: rgba(81, 207, 102, 0.1);
      border-radius: 5px;
      border-left: 4px solid #51cf66;
    }
    .warning-message {
      color: #ffd43b;
      font-size: 0.9em;
      margin-top: 5px;
      padding: 10px;
      background-color: rgba(255, 212, 59, 0.1);
      border-radius: 5px;
      border-left: 4px solid #ffd43b;
    }
    .back-link {
      color: #fff;
      text-decoration: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      margin-bottom: 20px;
      transition: color 0.3s ease;
    }
    .back-link:hover {
      color: #74c0fc;
      text-decoration: none;
    }
    .form-info {
      background-color: rgba(116, 192, 252, 0.1);
      border: 1px solid rgba(116, 192, 252, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #74c0fc;
      font-size: 14px;
    }
    .password-requirements {
      background-color: rgba(255, 212, 59, 0.1);
      border: 1px solid rgba(255, 212, 59, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #ffd43b;
      font-size: 13px;
    }
    .password-requirements ul {
      margin: 0;
      padding-left: 20px;
    }
    .password-requirements li {
      margin-bottom: 5px;
    }
    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #999;
      background: none;
      border: none;
      font-size: 16px;
    }
    .password-toggle:hover {
      color: #74c0fc;
    }
    .password-container {
      position: relative;
    }
  </style>
</head>

<body>
  <section class="fxt-template-animation fxt-template-layout6">
    <video autoplay muted loop playsinline class="video-background">
      <source src="images/video/artistic-video.mp4" type="video/mp4" />
    </video>

    <div class="fxt-content">
      <div class="fxt-header">
        <a href="index.html" class="fxt-logo">
          <img src="images/logo.png" style="width: 250px" alt="Logo" />
        </a>
      </div>
      <div class="fxt-form">
        <a href="login.html" class="back-link">
          <i class="fas fa-arrow-left me-2"></i>Back to Login
        </a>
        <h2 class="text-light">Create New Password</h2>
        
        <div class="form-info">
          <i class="fas fa-shield-alt me-2"></i>
          Please enter your new password. Make sure it's strong and secure.
        </div>

        <div class="password-requirements">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Password Requirements:</strong>
          <ul>
            <li>At least 8 characters long</li>
            <li>Contains at least one number</li>
            <li>Contains at least one uppercase letter</li>
            <li>Contains at least one lowercase letter</li>
          </ul>
        </div>

        <form id="resetPasswordForm" method="POST">
          <div class="form-group">
            <div class="fxt-transformY-50 fxt-transition-delay-3">
              <div class="password-container">
                <input
                  type="password"
                  class="form-control"
                  name="newPassword"
                  id="newPassword"
                  placeholder="Enter new password"
                  required="required"
                  style="padding-right: 45px;"
                />
                <button type="button" class="password-toggle" onclick="togglePassword('newPassword', this)">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            
            <br />
            
            <div class="fxt-transformY-50 fxt-transition-delay-4">
              <div class="password-container">
                <input
                  type="password"
                  class="form-control"
                  name="confirmPassword"
                  id="confirmPassword"
                  placeholder="Confirm new password"
                  required="required"
                  style="padding-right: 45px;"
                />
                <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            
            <br />
            <div id="formMessage"></div>
            <div class="fxt-transformY-50 fxt-transition-delay-5">
              <button type="submit" class="fxt-btn-fill" id="submitBtn">
                <i class="fas fa-lock me-2"></i>Reset Password
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="fxt-footer">
        <div class="fxt-transformY-50 fxt-transition-delay-10">
          <p>
            Remember your password?
            <a href="login.html" class="switcher-text2 inline-text">Login</a>
          </p>
        </div>
      </div>
    </div>
  </section>
  <!-- jquery-->
  <script src="js/jquery-lg.min.js"></script>
  <script src="js/bootstrap-lg.min.js"></script>
  <script src="js/imagesloaded.pkgd.min.js"></script>
  <script src="js/main-lg.js"></script>
  <script>
    // Get token and phoneno from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const phoneno = urlParams.get('phoneno');

    // Check if token and phone number are present
    if (!token || !phoneno) {
      showMessage("Invalid or expired reset link. Please request a new password reset.", "error");
      document.getElementById("resetPasswordForm").style.display = "none";
      setTimeout(() => {
        window.location.href = "forget-password.html";
      }, 3000);
    }

    document.getElementById("resetPasswordForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById("submitBtn");
      const originalText = submitBtn.innerHTML;
      
      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';

      // Collect form input values
      const newPassword = document.getElementById("newPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;

      // Client-side validation
      if (!newPassword || !confirmPassword) {
        showMessage("Both password fields are required.", "error");
        resetButton(submitBtn, originalText);
        return;
      }

      if (newPassword !== confirmPassword) {
        showMessage("Passwords do not match. Please try again.", "error");
        resetButton(submitBtn, originalText);
        return;
      }

      // Password strength validation
      if (!validatePassword(newPassword)) {
        showMessage("Password does not meet the requirements. Please check the requirements above.", "error");
        resetButton(submitBtn, originalText);
        return;
      }

      // Build payload
      const payload = {
        token: token,
        phoneno: phoneno,
        newPassword: newPassword
      };

      try {
        const res = await fetch("https://new-moto.onrender.com/api/v1/reset-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        
        if (res.ok) {
          showMessage(
            data.message || "Password reset successful! You can now login with your new password.", 
            "success"
          );
          
          // Clear form
          document.getElementById("resetPasswordForm").reset();
          
          // Redirect to login after 3 seconds
          setTimeout(() => {
            window.location.href = "login.html";
          }, 3000);
          
        } else {
          showMessage(data.message || "Failed to reset password. Please try again or request a new reset link.", "error");
        }
      } catch (fetchErr) {
        console.error("Network or parsing error:", fetchErr);
        showMessage("Failed to connect to the server. Please check your internet connection and try again.", "error");
      }

      resetButton(submitBtn, originalText);
    });

    function validatePassword(password) {
      // At least 8 characters, 1 uppercase, 1 lowercase, 1 number
      const minLength = password.length >= 8;
      const hasUppercase = /[A-Z]/.test(password);
      const hasLowercase = /[a-z]/.test(password);
      const hasNumber = /\d/.test(password);
      
      return minLength && hasUppercase && hasLowercase && hasNumber;
    }

    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      const icon = button.querySelector('i');
      
      if (input.type === "password") {
        input.type = "text";
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = "password";
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    function showMessage(message, type = "error") {
      const messageEl = document.getElementById("formMessage");
      messageEl.textContent = message;
      messageEl.className = `${type}-message`;
      
      // Auto-hide after 8 seconds for success messages
      if (type === "success") {
        setTimeout(() => {
          messageEl.textContent = "";
          messageEl.className = "";
        }, 8000);
      }
    }

    function resetButton(button, originalText) {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  </script>
</body>
</html> 